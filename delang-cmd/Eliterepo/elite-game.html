<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Space Trading Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #0f0;
            overflow: hidden;
        }

        #gameContainer {
            display: flex;
            height: 100vh;
        }

        #canvas {
            flex: 1;
            background-color: #000;
            border: 2px solid #0f0;
        }

        #ui {
            width: 250px;
            background-color: #001;
            border-left: 2px solid #0f0;
            padding: 10px;
            overflow-y: auto;
            font-size: 12px;
        }

        .ui-section {
            margin-bottom: 20px;
            border: 1px solid #0f0;
            padding: 10px;
        }

        .ui-section h3 {
            color: #0ff;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .ui-line {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        button {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px 10px;
            margin: 5px 0;
            cursor: pointer;
            width: 100%;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        button:hover {
            background-color: #0f0;
            color: #000;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .good-item {
            padding: 5px;
            margin: 3px 0;
            border: 1px solid #0f0;
            font-size: 11px;
        }

        .danger {
            color: #f00;
        }

        .safe {
            color: #0f0;
        }

        .warning {
            color: #ff0;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="canvas"></canvas>
        <div id="ui">
            <div class="ui-section">
                <h3>CMDR Status</h3>
                <div class="ui-line">
                    <span>Credits:</span>
                    <span id="credits">0</span>
                </div>
                <div class="ui-line">
                    <span>Rank:</span>
                    <span id="rank">Harmless</span>
                </div>
                <div class="ui-line">
                    <span>Health:</span>
                    <span id="health">100%</span>
                </div>
                <div class="ui-line">
                    <span>Fuel:</span>
                    <span id="fuel">100%</span>
                </div>
            </div>

            <div class="ui-section">
                <h3>Ship Status</h3>
                <div class="ui-line">
                    <span>Cargo:</span>
                    <span id="cargo">0/20</span>
                </div>
                <div class="ui-line">
                    <span>Shields:</span>
                    <span id="shields">0</span>
                </div>
                <div class="ui-line">
                    <span>Lasers:</span>
                    <span id="lasers">Pulse</span>
                </div>
            </div>

            <div class="ui-section">
                <h3>System Info</h3>
                <div id="systemInfo"></div>
            </div>

            <div class="ui-section">
                <h3>Market</h3>
                <div id="marketList"></div>
                <button id="buyBtn" onclick="buyGood()">BUY</button>
                <button id="sellBtn" onclick="sellGood()">SELL</button>
            </div>

            <div class="ui-section">
                <h3>Navigation</h3>
                <button onclick="jumpToRandom()">JUMP RANDOM</button>
                <button onclick="refuel()">REFUEL</button>
                <button onclick="restockAmmo()">RESTOCK</button>
            </div>

            <div class="ui-section">
                <h3>Upgrades</h3>
                <button id="shieldUpBtn" onclick="upgradeShields()">Shield+ (500)</button>
                <button id="laserUpBtn" onclick="upgradeLasers()">Laser+ (1000)</button>
                <button id="cargoUpBtn" onclick="upgradeCargoHold()">Cargo+ (300)</button>
                <button id="jumpUpBtn" onclick="upgradeJumpRange()">Jump+ (2000)</button>
            </div>
        </div>
    </div>

    <script>
        // ============ GAME STATE ============
        class GameState {
            constructor() {
                this.loadGame();
            }

            loadGame() {
                const saved = localStorage.getItem('eliteGameSave');
                if (saved) {
                    const data = JSON.parse(saved);
                    Object.assign(this, data);
                } else {
                    this.reset();
                }
            }

            reset() {
                this.credits = 1000;
                this.player = {
                    x: 0,
                    y: 0,
                    z: 0,
                    vx: 0,
                    vy: 0,
                    vz: 0,
                    roll: 0,
                    pitch: 0,
                    yaw: 0,
                    health: 100,
                    fuel: 127,
                    cargo: [],
                    cargoCapacity: 20,
                    shields: 0,
                    maxShields: 0,
                    laserType: 'pulse',
                    laserPower: 1,
                    jumpRange: 7,
                    combatKills: 0,
                    combatRank: 0
                };
                this.currentGalaxy = 0;
                this.currentSystem = 0;
                this.galaxies = this.generateGalaxies();
                this.enemies = [];
                this.inCombat = false;
                this.selectedGoodIndex = 0;
            }

            saveGame() {
                localStorage.setItem('eliteGameSave', JSON.stringify(this));
            }

            generateGalaxies() {
                const galaxies = [];
                for (let g = 0; g < 8; g++) {
                    const systems = [];
                    for (let s = 0; s < 256; s++) {
                        systems.push(this.generateSystem(g * 256 + s));
                    }
                    galaxies.push(systems);
                }
                return galaxies;
            }

            generateSystem(seed) {
                const rng = this.seededRandom(seed);
                
                const govTypes = ['Anarchy', 'Feudal', 'Multi-gov', 'Dictatorship', 'Communist', 'Confederacy', 'Democracy', 'Corporate'];
                const techLevels = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15];
                const goods = [
                    { name: 'Food', basePrice: 20, type: 'agricultural' },
                    { name: 'Textiles', basePrice: 40, type: 'industrial' },
                    { name: 'Radioactives', basePrice: 100, type: 'rare' },
                    { name: 'Machinery', basePrice: 60, type: 'industrial' },
                    { name: 'Alloys', basePrice: 80, type: 'industrial' },
                    { name: 'Computers', basePrice: 150, type: 'tech' },
                    { name: 'Alcohol', basePrice: 50, type: 'luxury' },
                    { name: 'Furs', basePrice: 120, type: 'luxury' },
                    { name: 'Gems', basePrice: 200, type: 'luxury' },
                    { name: 'Metal Ore', basePrice: 30, type: 'raw' },
                    { name: 'Minerals', basePrice: 45, type: 'raw' },
                    { name: 'Fuel', basePrice: 10, type: 'commodity' }
                ];

                const gov = govTypes[Math.floor(rng() * govTypes.length)];
                const tech = techLevels[Math.floor(rng() * techLevels.length)];
                const economy = rng();
                const danger = rng() * 0.7;

                const name = this.generateSystemName(seed);
                const market = [];

                for (let i = 0; i < 6; i++) {
                    const good = goods[Math.floor(rng() * goods.length)];
                    const priceMod = rng() * 2;
                    market.push({
                        name: good.name,
                        basePrice: good.basePrice,
                        price: Math.floor(good.basePrice * priceMod),
                        quantity: Math.floor(rng() * 200),
                        type: good.type
                    });
                }

                return {
                    name,
                    x: Math.floor(rng() * 256),
                    y: Math.floor(rng() * 256),
                    z: Math.floor(rng() * 256),
                    government: gov,
                    techLevel: tech,
                    economy,
                    danger,
                    population: Math.floor(rng() * 10),
                    market,
                    visited: false
                };
            }

            generateSystemName(seed) {
                const syllables = ['Ar', 'Av', 'Bo', 'Ce', 'Cr', 'Di', 'Ed', 'El', 'Fa', 'Ge', 'Hi', 'In', 'Jo', 'Ka', 'Ke', 'La', 'Le', 'Li', 'Ma', 'Me', 'Mu', 'Or', 'Pa', 'Pe', 'Re', 'Ri', 'Sa', 'So', 'St', 'Te', 'Ti', 'Tr', 'Ve', 'Za', 'Ze'];
                let name = '';
                for (let i = 0; i < 2 + Math.floor(this.seededRandom(seed + i) * 2); i++) {
                    name += syllables[Math.floor(this.seededRandom(seed + i * 10) * syllables.length)];
                }
                return name.charAt(0).toUpperCase() + name.slice(1);
            }

            seededRandom(seed) {
                const x = Math.sin(seed) * 10000;
                return x - Math.floor(x);
            }

            getCurrentSystem() {
                return this.galaxies[this.currentGalaxy][this.currentSystem];
            }
        }

        // ============ GAME LOGIC ============
        class Game {
            constructor() {
                this.state = new GameState();
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.input = {};
                this.setupInputHandlers();
                this.gameLoop();
            }

            setupInputHandlers() {
                document.addEventListener('keydown', (e) => {
                    this.input[e.key.toLowerCase()] = true;
                });
                document.addEventListener('keyup', (e) => {
                    this.input[e.key.toLowerCase()] = false;
                });
            }

            handleInput() {
                const p = this.state.player;
                const speed = 0.5;

                if (this.input['arrowup'] || this.input['w']) p.pitch -= 0.05;
                if (this.input['arrowdown'] || this.input['s']) p.pitch += 0.05;
                if (this.input['arrowleft'] || this.input['a']) p.roll -= 0.05;
                if (this.input['arrowright'] || this.input['d']) p.roll += 0.05;
                if (this.input[' ']) {
                    p.vz += speed;
                }

                p.pitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, p.pitch));
            }

            updatePhysics() {
                const p = this.state.player;
                const system = this.state.getCurrentSystem();

                p.x += p.vx;
                p.y += p.vy;
                p.z += p.vz;

                p.vx *= 0.98;
                p.vy *= 0.98;
                p.vz *= 0.98;

                if (p.vz > 0) {
                    p.fuel -= 0.1;
                    if (p.fuel <= 0) {
                        p.fuel = 0;
                        p.vz = 0;
                        alert('Out of fuel!');
                    }
                }

                if (!this.state.inCombat && Math.random() < 0.001 && system.danger > Math.random()) {
                    this.spawnEnemy(system.danger);
                }

                this.state.enemies.forEach(enemy => {
                    this.updateEnemy(enemy);
                });

                this.state.enemies = this.state.enemies.filter(e => e.health > 0 && e.z < 30000);
                this.state.inCombat = this.state.enemies.length > 0;
            }

            spawnEnemy(danger) {
                const types = ['Viper', 'Cobra', 'Python', 'Thargoid'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                this.state.enemies.push({
                    type,
                    x: (Math.random() - 0.5) * 100,
                    y: (Math.random() - 0.5) * 100,
                    z: 5000 + Math.random() * 5000,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    vz: -2,
                    health: 50 + Math.random() * 50,
                    maxHealth: 100,
                    size: 1 + Math.random() * 0.5
                });
            }

            updateEnemy(enemy) {
                const p = this.state.player;
                const dx = p.x - enemy.x;
                const dy = p.y - enemy.y;
                const dz = p.z - enemy.z;
                const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);

                if (dist < 100) {
                    const angle = Math.atan2(dy, dx);
                    enemy.vx += Math.cos(angle) * 0.05;
                    enemy.vy += Math.sin(angle) * 0.05;
                }

                enemy.x += enemy.vx;
                enemy.y += enemy.vy;
                enemy.z += enemy.vz;

                if (dist < 3000 && Math.random() < 0.02) {
                    const damage = 10 + Math.random() * 20;
                    p.health -= damage / (p.maxShields + 1);
                    if (p.health < 0) {
                        alert('Ship destroyed!');
                        this.state.reset();
                    }
                }
            }

            render() {
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                const cx = this.canvas.width / 2;
                const cy = this.canvas.height / 2;

                this.ctx.strokeStyle = '#0f0';
                this.ctx.lineWidth = 1;

                this.ctx.beginPath();
                this.ctx.arc(cx, cy, 10, 0, Math.PI * 2);
                this.ctx.stroke();

                this.ctx.beginPath();
                this.ctx.moveTo(cx - 20, cy);
                this.ctx.lineTo(cx + 20, cy);
                this.ctx.moveTo(cx, cy - 20);
                this.ctx.lineTo(cx, cy + 20);
                this.ctx.stroke();

                this.state.enemies.forEach(enemy => {
                    const screenX = cx + (enemy.x / enemy.z) * 500;
                    const screenY = cy + (enemy.y / enemy.z) * 500;
                    const size = 50 / (enemy.z / 1000);

                    this.ctx.strokeStyle = enemy.type === 'Thargoid' ? '#f00' : '#0ff';
                    this.ctx.lineWidth = 2;

                    this.ctx.beginPath();
                    this.ctx.moveTo(screenX, screenY - size);
                    this.ctx.lineTo(screenX + size, screenY + size);
                    this.ctx.moveTo(screenX + size, screenY + size);
                    this.ctx.lineTo(screenX - size, screenY + size);
                    this.ctx.moveTo(screenX - size, screenY + size);
                    this.ctx.lineTo(screenX, screenY - size);
                    this.ctx.stroke();

                    const dist = Math.sqrt(enemy.x*enemy.x + enemy.y*enemy.y + enemy.z*enemy.z);
                    this.ctx.fillStyle = '#0f0';
                    this.ctx.font = '12px Arial';
                    this.ctx.fillText(Math.floor(dist) + 'm', screenX, screenY - size - 10);
                });

                this.drawRadar();

                this.ctx.fillStyle = '#0f0';
                this.ctx.font = '12px Courier';
                this.ctx.fillText('FUEL: ' + Math.floor(this.state.player.fuel), 10, 20);
                this.ctx.fillText('HEALTH: ' + Math.floor(this.state.player.health) + '%', 10, 40);
                this.ctx.fillText('SYSTEM: ' + this.state.getCurrentSystem().name, 10, 60);
                
                if (this.state.inCombat) {
                    this.ctx.fillStyle = '#f00';
                    this.ctx.font = 'bold 20px Courier';
                    this.ctx.fillText('COMBAT!', this.canvas.width / 2 - 50, 30);
                }
            }

            drawRadar() {
                const radarX = this.canvas.width - 120;
                const radarY = 20;
                const radarSize = 100;

                this.ctx.strokeStyle = '#0f0';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(radarX, radarY, radarSize, radarSize);

                this.state.enemies.forEach(enemy => {
                    const scale = radarSize / 10000;
                    const ex = radarX + radarSize / 2 + enemy.x * scale;
                    const ey = radarY + radarSize / 2 + enemy.y * scale;

                    this.ctx.fillStyle = enemy.type === 'Thargoid' ? '#f00' : '#0ff';
                    this.ctx.fillRect(ex - 2, ey - 2, 4, 4);
                });
            }

            updateUI() {
                document.getElementById('credits').textContent = this.state.credits;
                document.getElementById('health').textContent = Math.floor(this.state.player.health) + '%';
                document.getElementById('fuel').textContent = Math.floor(this.state.player.fuel);
                document.getElementById('cargo').textContent = this.state.player.cargo.length + '/' + this.state.player.cargoCapacity;
                document.getElementById('shields').textContent = this.state.player.maxShields;
                document.getElementById('lasers').textContent = this.state.player.laserType;
                document.getElementById('rank').textContent = this.getRankName();

                const system = this.state.getCurrentSystem();
                const dangerClass = system.danger > 0.5 ? 'danger' : system.danger > 0.2 ? 'warning' : 'safe';
                document.getElementById('systemInfo').innerHTML = `
                    <div>${system.name}</div>
                    <div>Gov: ${system.government}</div>
                    <div>Tech: ${system.techLevel}</div>
                    <div class="${dangerClass}">Danger: ${Math.floor(system.danger * 100)}%</div>
                `;

                let marketHtml = '';
                system.market.forEach((good, i) => {
                    marketHtml += `<div class="good-item" onclick="selectGood(${i})" style="background-color: ${this.state.selectedGoodIndex === i ? '#0f0' : '#000'}; color: ${this.state.selectedGoodIndex === i ? '#000' : '#0f0'}">
                        ${good.name}: ${good.price}cr (x${good.quantity})
                    </div>`;
                });
                document.getElementById('marketList').innerHTML = marketHtml;

                document.getElementById('buyBtn').disabled = this.state.credits < (system.market[this.state.selectedGoodIndex]?.price || 0) || this.state.player.cargo.length >= this.state.player.cargoCapacity;
                document.getElementById('sellBtn').disabled = !this.state.player.cargo.some(c => c.name === system.market[this.state.selectedGoodIndex]?.name);
            }

            getRankName() {
                const ranks = ['Harmless', 'Mostly Harmless', 'Poor', 'Competent', 'Dangerous', 'Deadly', 'Elite'];
                return ranks[Math.min(this.state.player.combatRank, ranks.length - 1)];
            }

            gameLoop() {
                this.handleInput();
                this.updatePhysics();
                this.render();
                this.updateUI();
                this.state.saveGame();
                requestAnimationFrame(() => this.gameLoop());
            }
        }

        // ============ GLOBAL GAME INSTANCE ============
        let game;

        function selectGood(index) {
            game.state.selectedGoodIndex = index;
        }

        function buyGood() {
            const system = game.state.getCurrentSystem();
            const good = system.market[game.state.selectedGoodIndex];
            
            if (game.state.credits >= good.price && game.state.player.cargo.length < game.state.player.cargoCapacity) {
                game.state.credits -= good.price;
                game.state.player.cargo.push({ name: good.name, boughtAt: good.price });
                good.quantity -= 1;
            }
        }

        function sellGood() {
            const system = game.state.getCurrentSystem();
            const good = system.market[game.state.selectedGoodIndex];
            const cargoIndex = game.state.player.cargo.findIndex(c => c.name === good.name);
            
            if (cargoIndex >= 0) {
                const profit = good.price;
                game.state.credits += profit;
                game.state.player.cargo.splice(cargoIndex, 1);
                good.quantity += 1;
            }
        }

        function jumpToRandom() {
            if (game.state.player.fuel >= game.state.player.jumpRange) {
                game.state.player.fuel -= game.state.player.jumpRange;
                game.state.currentSystem = Math.floor(Math.random() * 256);
                game.state.enemies = [];
                game.state.inCombat = false;
                game.state.player.health = 100;
            } else {
                alert('Not enough fuel!');
            }
        }

        function refuel() {
            const cost = Math.floor((127 - game.state.player.fuel) * 0.5);
            if (game.state.credits >= cost) {
                game.state.credits -= cost;
                game.state.player.fuel = 127;
            } else {
                alert('Not enough credits!');
            }
        }

        function restockAmmo() {
            const cost = 500;
            if (game.state.credits >= cost) {
                game.state.credits -= cost;
                game.state.player.health = 100;
            } else {
                alert('Not enough credits!');
            }
        }

        function upgradeShields() {
            if (game.state.credits >= 500) {
                game.state.credits -= 500;
                game.state.player.maxShields += 50;
            } else {
                alert('Not enough credits!');
            }
        }

        function upgradeLasers() {
            if (game.state.credits >= 1000) {
                game.state.credits -= 1000;
                game.state.player.laserType = 'Military';
                game.state.player.laserPower += 1;
            } else {
                alert('Not enough credits!');
            }
        }

        function upgradeCargoHold() {
            if (game.state.credits >= 300) {
                game.state.credits -= 300;
                game.state.player.cargoCapacity += 10;
            } else {
                alert('Not enough credits!');
            }
        }

        function upgradeJumpRange() {
            if (game.state.credits >= 2000) {
                game.state.credits -= 2000;
                game.state.player.jumpRange += 3;
            } else {
                alert('Not enough credits!');
            }
        }

        window.addEventListener('load', () => {
            game = new Game();
        });
    </script>
</body>
</html>
